name: Publish dev APT repo

on:
  push:
    branches: [dev, main]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  publish-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Install build + repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aptly gnupg devscripts debhelper dh-make fakeroot lintian build-essential

      - name: Select signing key + distro
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "SIGNING_KEY_SECRET=APT_SIGNING_KEY_PROD" >> "$GITHUB_ENV"
            echo "DISTRO=bookworm" >> "$GITHUB_ENV"
          else
            echo "SIGNING_KEY_SECRET=APT_SIGNING_KEY_DEV" >> "$GITHUB_ENV"
            echo "DISTRO=bookworm-dev" >> "$GITHUB_ENV"
          fi

      - name: Import GPG key
        env:
          APT_SIGNING_KEY_DEV: ${{ secrets.APT_SIGNING_KEY_DEV }}
          APT_SIGNING_KEY_PROD: ${{ secrets.APT_SIGNING_KEY_DEV }}
        run: |
          if [ "$SIGNING_KEY_SECRET" = "APT_SIGNING_KEY_PROD" ]; then
            KEY="$APT_SIGNING_KEY_PROD"
          else
            KEY="$APT_SIGNING_KEY_DEV"
          fi
          if [ -z "${KEY:-}" ]; then
            echo "No GPG key available. Set $SIGNING_KEY_SECRET."
            exit 1
          fi
          printf '%s' "$KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Build .deb packages
        run: |
          set -euo pipefail
          for pkg in \
            packages/beaver-core-config \
            packages/beaver-core \
            packages/beaver-ai \
            packages/beaver-internet \
            packages/beaver-social \
            packages/beaver-mail \
            packages/beaver; do
            (cd "$pkg" && dpkg-buildpackage -us -uc -b)
          done

      - name: Collect .deb files
        run: |
          set -euo pipefail
          mkdir -p /tmp/beaver-debs
          find packages -maxdepth 1 -type f -name "*.deb" -print -exec cp -v {} /tmp/beaver-debs/ \;

      - name: Publish repo to temp dir
        run: |
          set -euo pipefail
          KEY_ID="$(gpg --list-secret-keys --keyid-format LONG | awk '/^sec/ {print $2}' | head -n1 | cut -d/ -f2 || true)"
          if [ -z "$KEY_ID" ]; then
            echo "No GPG key available."
            exit 1
          fi
          ./scripts/aptly-init.sh
          if [ "$DISTRO" = "bookworm" ]; then
            ./scripts/aptly-add.sh beaver /tmp/beaver-debs/*.deb
            PUBLISH_DIR=/tmp/apt GPG_KEY="$KEY_ID" ./scripts/aptly-publish.sh
          else
            ./scripts/aptly-add.sh beaver-dev /tmp/beaver-debs/*.deb
            PUBLISH_DIR=/tmp/apt GPG_KEY="$KEY_ID" ./scripts/aptly-publish-dev.sh
          fi

      - name: Inspect published output
        run: |
          set -euo pipefail
          echo "Contents of /tmp/apt/dists:"
          ls -la /tmp/apt/dists || true
          echo "Contents of /tmp/apt/dists/bookworm:"
          ls -la /tmp/apt/dists/bookworm || true
          echo "Contents of /tmp/apt/dists/bookworm-dev:"
          ls -la /tmp/apt/dists/bookworm-dev || true

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Sync repo into main/docs/apt (no delete)
        run: |
          set -euo pipefail
          mkdir -p main/docs/apt
          rsync -a /tmp/apt/ main/docs/apt/

      - name: Commit and push
        run: |
          set -euo pipefail
          cd main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q '^'; then
            git add docs/apt
            git commit -m "Publish APT repo (CI)"
            git push origin main
          else
            echo "No changes to publish."
          fi
