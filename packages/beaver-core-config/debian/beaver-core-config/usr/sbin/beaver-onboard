#!/bin/sh
set -eu

VERSION="0.1.0"

usage() {
  cat <<'EOF'
beaver-onboard - initial setup for Beaver (v0.1)

Usage:
  beaver-onboard init
      Ensure /userdata exists and create /userdata/home.

  beaver-onboard add-user <username>
      Create a host user account (Linux user) and prepare /userdata/home/<username>.

  beaver-onboard add-key <username> [--file <path>]
      Add an SSH public key to <username> by pasting it or from a file.

Notes:
- This v0.1 does NOT partition disks or modify boot configuration.
- It does NOT disable root login or change sshd settings.
- It is safe to run multiple times.

Examples:
  sudo beaver-onboard init
  sudo beaver-onboard add-user alice
  sudo beaver-onboard add-key alice
  sudo beaver-onboard add-key alice --file /tmp/alice.pub
EOF
}

need_root() {
  if [ "$(id -u)" -ne 0 ]; then
    echo "ERROR: Please run as root (use sudo)." >&2
    exit 1
  fi
}

ensure_userdata() {
  # For now: /userdata is just a directory. Later we can mount a partition there.
  if [ ! -d /userdata ]; then
    mkdir -p /userdata
  fi

  mkdir -p /userdata/home

  # Conservative permissions: readable by all, writable only by root.
  # Individual user dirs under /userdata/home will be owned by the user.
  chmod 755 /userdata /userdata/home
}

create_user() {
  username="$1"

  case "$username" in
    ""|*[^a-zA-Z0-9._-]*)
      echo "ERROR: Invalid username '$username'." >&2
      exit 1
      ;;
  esac

  if id "$username" >/dev/null 2>&1; then
    echo "User '$username' already exists."
  else
    # Use adduser if available (friendlier), otherwise useradd
    if command -v adduser >/dev/null 2>&1; then
      adduser --disabled-password --gecos "" "$username"
      echo "Created user '$username' (no password set)."
      echo "Set a password with: sudo passwd $username"
    else
      useradd -m -s /bin/bash "$username"
      echo "Created user '$username'."
      echo "Set a password with: sudo passwd $username"
    fi
  fi

  ensure_userdata

  # Create userdata home area for the user (separate from /home for now)
  mkdir -p "/userdata/home/$username"
  chown "$username:$username" "/userdata/home/$username"
  chmod 700 "/userdata/home/$username"

  echo "Prepared /userdata/home/$username"
}

read_key_from_stdin() {
  echo "Paste ONE ssh public key line (starts with 'ssh-ed25519' or 'ssh-rsa'), then press Enter:"
  # Read one line only; don't echo extra prompts to stdout
  IFS= read -r key || true
  if [ -z "${key:-}" ]; then
    echo "ERROR: No key provided." >&2
    exit 1
  fi
  echo "$key"
}

validate_key_line() {
  key="$1"
  # Minimal sanity check: starts with ssh- and has at least 2 fields
  # (type + base64)
  set -- $key
  if [ "${1:-}" = "" ] || [ "${2:-}" = "" ]; then
    echo "ERROR: Key does not look valid (expected: '<type> <base64> [comment]')." >&2
    exit 1
  fi
  case "$1" in
    ssh-ed25519|ssh-rsa|ecdsa-sha2-nistp256|sk-ssh-ed25519@openssh.com|sk-ecdsa-sha2-nistp256@openssh.com)
      ;;
    *)
      echo "WARNING: Unrecognized key type '$1'. Continuing anyway." >&2
      ;;
  esac
}

add_key() {
  username="$1"
  shift || true

  if ! id "$username" >/dev/null 2>&1; then
    echo "ERROR: User '$username' does not exist. Create it first with: sudo beaver-onboard add-user $username" >&2
    exit 1
  fi

  file_path=""
  if [ "${1:-}" = "--file" ]; then
    file_path="${2:-}"
    if [ -z "$file_path" ] || [ ! -f "$file_path" ]; then
      echo "ERROR: --file requires an existing file path." >&2
      exit 1
    fi
    key="$(cat "$file_path")"
  else
    key="$(read_key_from_stdin)"
  fi

  # Normalize: keep only the first line (some apps add newline at end)
  key="$(printf "%s" "$key" | head -n 1)"
  validate_key_line "$key"

  home_dir="$(getent passwd "$username" | cut -d: -f6)"
  if [ -z "$home_dir" ]; then
    echo "ERROR: Could not determine home directory for '$username'." >&2
    exit 1
  fi

  ssh_dir="$home_dir/.ssh"
  auth_file="$ssh_dir/authorized_keys"

  mkdir -p "$ssh_dir"
  chmod 700 "$ssh_dir"
  touch "$auth_file"
  chmod 600 "$auth_file"
  chown -R "$username:$username" "$ssh_dir"

  # Avoid duplicate line exact matches
  if grep -Fxq "$key" "$auth_file"; then
    echo "Key already present in $auth_file"
  else
    printf "%s\n" "$key" >> "$auth_file"
    chown "$username:$username" "$auth_file"
    echo "Added key for '$username' to $auth_file"
  fi

  echo "Next: user can login via SSH as '$username' (depending on sshd config)."
}

main() {
  cmd="${1:-}"
  case "$cmd" in
    ""|-h|--help|help)
      usage
      exit 0
      ;;
    --version)
      echo "beaver-onboard $VERSION"
      exit 0
      ;;
    init)
      need_root
      ensure_userdata
      echo "OK: /userdata and /userdata/home are ready."
      exit 0
      ;;
    add-user)
      need_root
      username="${2:-}"
      if [ -z "$username" ]; then usage; exit 1; fi
      create_user "$username"
      exit 0
      ;;
    add-key)
      need_root
      username="${2:-}"
      if [ -z "$username" ]; then usage; exit 1; fi
      shift 2
      add_key "$username" "$@"
      exit 0
      ;;
    *)
      echo "ERROR: Unknown command '$cmd'." >&2
      usage
      exit 1
      ;;
  esac
}

main "$@"
